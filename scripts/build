#!/bin/bash
set -e

# Configuration
IMAGE_NAME="telora-daemon:latest"
CONTAINER_ENGINE=$(command -v podman || command -v docker)

if [ -z "$CONTAINER_ENGINE" ]; then
    echo "Error: Podman or Docker is required."
    exit 1
fi

echo "--> Using $CONTAINER_ENGINE to build Telora"

# Build the container
$CONTAINER_ENGINE build -t "$IMAGE_NAME" .

# Create bin directory if it doesn't exist
mkdir -p bin

# Extract the binaries
echo "--> Extracting binaries to ./bin/"
$CONTAINER_ENGINE run --rm --entrypoint /bin/sh "$IMAGE_NAME" -c "cat /usr/bin/telora-daemon" > bin/telora-daemon
$CONTAINER_ENGINE run --rm --entrypoint /bin/sh "$IMAGE_NAME" -c "cat /usr/bin/telora" > bin/telora
$CONTAINER_ENGINE run --rm --entrypoint /bin/sh "$IMAGE_NAME" -c "cat /usr/bin/telora-models" > bin/telora-models

chmod +x bin/telora-daemon bin/telora bin/telora-models

echo "--> Build complete!"
echo "--> Binaries are in ./bin/"
echo "--> Or run manually: ./bin/telora-daemon"

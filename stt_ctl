#!/usr/bin/env bash
set -euo pipefail

# stt_ctl - Control script for STT Daemon and Client (Rust)
STT_PATH="/home/wolf/.local/share/stt-assistant"
RUST_DAEMON="${STT_PATH}/bin/stt-daemon"
RUST_CLIENT="${STT_PATH}/bin/stt-client"

status() {
    if pgrep -x "stt-daemon" > /dev/null; then
        echo "STT Daemon: RUNNING"
    else
        echo "STT Daemon: STOPPED"
    fi

    if pgrep -x "stt-client" > /dev/null; then
        echo "STT Client: RUNNING"
    else
        echo "STT Client: STOPPED"
    fi
}

stop() {
    echo "Stopping services..."
    pkill -x "stt-daemon" || true
    pkill -x "stt-client" || true
}

start() {
    status_output=$(status)
    if echo "${status_output}" | grep -q "RUNNING"; then
        echo "Some services already running. Restarting..."
        stop
        sleep 1
    fi

    if [[ ! -f "${RUST_DAEMON}" ]]; then
        echo "Error: Daemon binary not found at ${RUST_DAEMON}"
        echo "Run ./build.bash first."
        exit 1
    fi

    if [[ ! -f "${RUST_CLIENT}" ]]; then
        echo "Error: Client binary not found at ${RUST_CLIENT}"
        echo "Run ./build.bash first."
        exit 1
    fi

    echo "Starting STT Daemon..."
    nohup "${RUST_DAEMON}" > /tmp/stt_daemon.log 2>&1 &

    echo "Starting STT Client..."
    nohup "${RUST_CLIENT}" > /tmp/stt_client.log 2>&1 &

    echo "Services started."
}

case "${1:-}" in
    start)   start ;;
    stop)    stop ;;
    restart) stop; sleep 1; start ;;
    status)  status ;;
    *)       echo "Usage: $0 {start|stop|restart|status}"; exit 1 ;;
esac
